<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airplane Inspection</title>
    <style>
        /* ========================================
           RESET & BASE STYLES
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #000000;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            display: flex;
        }

        /* ========================================
           LEFT SIDEBAR (PERSISTENT)
           ======================================== */
        .left-sidebar {
            width: 250px;
            background: #f5f5f5;
            border-right: 2px solid #000000;
            padding: 30px 20px;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .profile-picture-container {
            margin-bottom: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .profile-picture {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #000000;
            overflow: hidden;
        }

        .profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-picture-placeholder {
            width: 100%;
            height: 100%;
            background: #cccccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 2rem;
            font-weight: bold;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            color: #000000;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            border-radius: 4px;
            cursor: pointer;
        }

        .sidebar-nav-item:hover {
            background: #000000;
            color: #ffffff;
        }

        .sidebar-nav-item.active {
            background: #000000;
            color: #ffffff;
        }

        .sidebar-nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .main-content-wrapper {
            margin-left: 250px;
            flex: 1;
            width: calc(100% - 250px);
        }

        /* ========================================
           PAGE SECTIONS (HIDDEN/SHOW)
           ======================================== */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ========================================
           PAGE 0: HOMEPAGE
           ======================================== */
        .homepage-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .new-inspection-btn {
            padding: 20px 50px;
            background: #000000;
            border: 2px solid #000000;
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            min-height: 70px;
            min-width: 250px;
        }

        .new-inspection-btn:hover {
            background: #ffffff;
            color: #000000;
        }

        /* ========================================
           PAGE 1: AREA SELECTION
           ======================================== */
        #page1 {
            position: relative;
            min-height: 100vh;
            background-color: #000000;
            padding: 40px 20px;
            background-image: url('/uiImage/PlaneIllu.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        #page1 .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            padding: 40px 20px;
            min-height: calc(100vh - 80px);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            text-align: center;
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 50px;
            color: #000000;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        #page1 h1 {
            color: #ffffff;
            margin-bottom: 30px;
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 400;
            margin-bottom: 30px;
            color: #000000;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #000000;
            padding-bottom: 10px;
        }

        #page1 h2 {
            color: #ffffff;
            border-bottom: 2px solid #ffffff;
            text-align: center;
            margin-bottom: 30px;
        }

        .area-section {
            margin-bottom: 50px;
        }

        .start-inspection-container {
            display: flex;
            justify-content: center;
            margin-top: 60px;
            padding-bottom: 40px;
        }

        .start-inspection-btn {
            padding: 20px 50px;
            background: #000000;
            border: 2px solid #000000;
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            min-height: 70px;
            min-width: 250px;
        }

        .start-inspection-btn:hover:not(:disabled) {
            background: #ffffff;
            color: #000000;
        }

        .start-inspection-btn:disabled {
            background: #f5f5f5;
            border-color: #cccccc;
            color: #999999;
            cursor: not-allowed;
        }

        .start-inspection-btn:disabled:hover {
            background: #f5f5f5;
            color: #999999;
        }

        /* ========================================
           PAGE 2: IMAGE INPUT
           ======================================== */

        .area-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .area-btn {
            padding: 20px 15px;
            background: #ffffff;
            border: 2px solid #000000;
            color: #000000;
            font-size: 1rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .area-btn:hover {
            background: #000000;
            color: #ffffff;
        }

        .area-btn.selected {
            background: #000000;
            color: #ffffff;
        }

        .image-section {
            margin-top: 50px;
        }

        .image-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .image-btn {
            padding: 18px;
            background: #ffffff;
            border: 2px solid #000000;
            color: #000000;
            font-size: 1rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-height: 60px;
        }

        .image-btn:hover {
            background: #000000;
            color: #ffffff;
        }

        .image-btn:disabled {
            background: #f5f5f5;
            border-color: #cccccc;
            color: #999999;
            cursor: not-allowed;
        }

        .image-btn:disabled:hover {
            background: #f5f5f5;
            color: #999999;
        }

        #fileInput {
            display: none;
        }

        .image-preview-container {
            margin-top: 30px;
        }

        .image-thumbnails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-thumbnail-wrapper {
            position: relative;
            border: 2px solid #000000;
            padding: 5px;
            background: #ffffff;
        }

        .image-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-thumbnail-name {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
            text-align: center;
            word-break: break-all;
        }

        .thumbnail-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .thumbnail-remove:hover {
            background: rgba(255, 0, 0, 1);
        }

        .analyze-btn-container {
            margin-top: 30px;
            text-align: center;
        }

        .analyze-btn {
            padding: 18px 50px;
            background: #000000;
            border: 2px solid #000000;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-height: 60px;
            min-width: 200px;
        }

        .analyze-btn:hover {
            background: #ffffff;
            color: #000000;
        }

        .analyze-btn:disabled {
            background: #f5f5f5;
            border-color: #cccccc;
            color: #999999;
            cursor: not-allowed;
        }

        .analyze-btn:disabled:hover {
            background: #f5f5f5;
            color: #999999;
        }

        /* ========================================
           PAGE 3: ANALYSIS RESULTS
           ======================================== */
        .results-page-container {
            min-height: 100vh;
            padding: 40px 20px;
        }

        .results-header {
            text-align: center;
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 40px;
            color: #000000;
            letter-spacing: 2px;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px;
        }

        .home-btn {
            padding: 12px 24px;
            background: #ffffff;
            border: 2px solid #000000;
            color: #000000;
            font-size: 0.9rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-height: 50px;
        }

        .home-btn:hover {
            background: #000000;
            color: #ffffff;
        }

        .results-header-text {
            flex: 1;
        }

        .results-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .results-image-section {
            position: relative;
        }

        .image-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border: 2px solid #000000;
        }

        .image-nav-btn {
            padding: 10px 20px;
            background: #ffffff;
            border: 2px solid #000000;
            color: #000000;
            font-size: 0.9rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 100px;
        }

        .image-nav-btn:hover:not(:disabled) {
            background: #000000;
            color: #ffffff;
        }

        .image-nav-btn:disabled {
            background: #f5f5f5;
            border-color: #cccccc;
            color: #999999;
            cursor: not-allowed;
        }

        .image-counter {
            font-size: 1rem;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .results-image-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 100%;
        }

        .results-image {
            width: 100%;
            height: auto;
            border: 2px solid #000000;
            display: block;
        }

        .defect-box {
            position: absolute;
            border: 3px solid red;
            background: rgba(255, 0, 0, 0.1);
            pointer-events: none;
            box-sizing: border-box;
            transition: border-width 0.2s, background 0.2s;
        }

        .defect-box.highlighted {
            border: 4px solid #ffc107;
            background: rgba(255, 193, 7, 0.3);
            z-index: 100;
        }

        .defect-label {
            position: absolute;
            background: red;
            color: white;
            padding: 5px 10px;
            font-size: 0.85rem;
            font-weight: bold;
            border-radius: 4px;
            top: -30px;
            left: 0;
            white-space: nowrap;
            z-index: 10;
        }

        .detections-list-section {
            border: 2px solid #000000;
            padding: 15px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .detections-header {
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #000000;
            padding-bottom: 10px;
        }

        .confidence-filter-section {
            margin-bottom: 15px;
            padding: 12px;
            background: #f5f5f5;
            border: 1px solid #000000;
        }

        .confidence-filter-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .confidence-filter-value {
            font-weight: 600;
            color: #000000;
        }

        .confidence-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .confidence-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #000000;
            cursor: pointer;
            border: 2px solid #ffffff;
        }

        .confidence-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #000000;
            cursor: pointer;
            border: 2px solid #ffffff;
        }

        .detection-count {
            font-size: 0.75rem;
            color: #666666;
            margin-top: 5px;
            text-align: right;
        }

        .detection-item {
            padding: 12px;
            border-bottom: 1px solid #cccccc;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s, opacity 0.2s;
            display: flex;
            gap: 10px;
            position: relative;
        }

        .detection-item:hover {
            background: #f5f5f5;
        }

        .detection-item.highlighted {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .detection-item.false-positive {
            opacity: 0.4;
        }

        .detection-item.false-positive:hover {
            opacity: 0.5;
        }

        .detection-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .detection-header {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            flex: 1;
        }

        .false-positive-x-button {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: #ff0000;
            color: white;
            border: 2px solid #000000;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s;
            z-index: 10;
            flex-shrink: 0;
        }

        .false-positive-x-button:hover {
            background: #cc0000;
            transform: scale(1.1);
        }

        .detection-item.false-positive .false-positive-x-button {
            background: #999999;
            border-color: #666666;
            opacity: 0.6;
            font-size: 16px;
        }

        .detection-item.false-positive .false-positive-x-button:hover {
            background: #666666;
            opacity: 0.8;
        }

        .defect-thumbnail {
            width: 72px;
            height: 72px;
            object-fit: cover;
            border: 2px solid #000000;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .defect-thumbnail:hover {
            transform: scale(1.05);
            border-color: #ff0000;
        }

        .detection-info {
            flex: 1;
            min-width: 0;
        }

        .detection-type {
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
        }

        .detection-confidence {
            color: #666666;
            font-size: 0.8rem;
            margin-bottom: 3px;
        }

        .detection-image-source {
            color: #666666;
            font-size: 0.75rem;
            margin-bottom: 3px;
            font-style: italic;
        }

        .detection-coords {
            color: #999999;
            font-size: 0.75rem;
            font-family: monospace;
        }

        .defect-box.false-positive {
            opacity: 0.4;
            border-color: #999999;
        }

        .defect-box.hidden {
            display: none;
        }

        .no-detections {
            padding: 40px;
            text-align: center;
            border: 2px solid #000000;
            margin-top: 20px;
        }

        .no-detections-text {
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .inspect-another-btn {
            margin-top: 40px;
            padding: 18px 50px;
            background: #000000;
            border: 2px solid #000000;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-height: 60px;
            width: 100%;
        }

        .inspect-another-btn:hover {
            background: #ffffff;
            color: #000000;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f5f5f5;
            border-top: 3px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========================================
           MOBILE RESPONSIVE
           ======================================== */
        @media (max-width: 900px) {
            .left-sidebar {
                width: 200px;
                padding: 20px 15px;
            }

            .profile-picture {
                width: 60px;
                height: 60px;
            }

            .main-content-wrapper {
                margin-left: 200px;
                width: calc(100% - 200px);
            }

            .homepage-container {
                padding: 20px;
            }

            #page1 {
                background-size: cover;
            }

            @media (max-width: 600px) {
                .left-sidebar {
                    width: 70px;
                    padding: 15px 10px;
                }

                .profile-picture {
                    width: 50px;
                    height: 50px;
                }

                .sidebar-nav-item span:not(.sidebar-nav-icon) {
                    display: none;
                }

                .sidebar-nav-item {
                    justify-content: center;
                    padding: 12px;
                }

                .main-content-wrapper {
                    margin-left: 70px;
                    width: calc(100% - 70px);
                }
            }

            .results-layout {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .detections-list-section {
                max-height: none;
            }

            .container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 30px;
            }

            .area-buttons {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .image-buttons {
                grid-template-columns: 1fr;
            }

            .analyze-btn {
                width: 100%;
                min-width: auto;
            }

            .start-inspection-btn {
                width: 100%;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- ========================================
         LEFT SIDEBAR (PERSISTENT ON ALL PAGES)
         ======================================== -->
    <div class="left-sidebar">
        <div class="profile-picture-container">
            <div class="profile-picture">
                <div class="profile-picture-placeholder">üë§</div>
                <!-- Alternative: Use an image
                <img src="path-to-profile-image.jpg" alt="Profile">
                -->
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="sidebar-nav-item" id="sidebarHomeBtn">
                <span>Home</span>
            </a>
        </nav>
    </div>

    <!-- ========================================
         MAIN CONTENT WRAPPER
         ======================================== -->
    <div class="main-content-wrapper">
        <!-- PAGE 0: Homepage -->
        <div class="page active" id="page0">
            <div class="homepage-container">
                <button class="new-inspection-btn" id="newInspectionBtn">New Inspection</button>
            </div>
        </div>

    <!-- ========================================
         PAGE 1: AREA SELECTION
         ======================================== -->
    <div class="page" id="page1">
        <div class="container">
            <h1>Airplane Inspection</h1>

            <div class="area-section">
                <h2>Select Area</h2>
                <div class="area-buttons">
                    <button class="area-btn" data-area="fuselage">Fuselage</button>
                    <button class="area-btn" data-area="left-wing">Left Wing</button>
                    <button class="area-btn" data-area="right-wing">Right Wing</button>
                    <button class="area-btn" data-area="tail">Tail</button>
                    <button class="area-btn" data-area="engine">Engine</button>
                    <button class="area-btn" data-area="landing-gear">Landing Gear</button>
                </div>
            </div>

            <div class="start-inspection-container">
                <button class="start-inspection-btn" id="startInspectionBtn" disabled>Start Inspection</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         PAGE 2: IMAGE INPUT
         ======================================== -->
    <div class="page" id="page2">
        <div class="container">
            <h1>Airplane Inspection</h1>

            <div class="image-section">
                <h2>Capture or Upload Image</h2>
                <div class="image-buttons">
                    <button class="image-btn" id="takePhotoBtn">Take Photo</button>
                    <button class="image-btn" id="uploadImageBtn">Upload Image</button>
                </div>

                <input type="file" id="fileInput" accept="image/*" capture="environment" multiple>

                <div class="image-preview-container">
                    <div id="imageThumbnailsGrid" class="image-thumbnails-grid"></div>
                </div>

                <div class="analyze-btn-container">
                    <button class="analyze-btn" id="analyzeBtn" disabled>Analyze Images</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         PAGE 3: ANALYSIS RESULTS
         ======================================== -->
    <div class="page" id="page3">
        <div class="results-page-container">
            <div class="loading" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Analyzing image... Please wait.</p>
            </div>

            <div class="results-content" id="resultsContent" style="display: none;">
                <h1 class="results-header">
                    <button class="home-btn" id="homeBtn">Home</button>
                    <span class="results-header-text">Inspection Results</span>
                    <div style="width: 140px;"></div>
                </h1>
                
                <div class="results-layout">
                    <!-- Left Side: Image with Detections -->
                    <div class="results-image-section">
                        <div class="image-navigation" id="imageNavigation" style="display: none;">
                            <button class="image-nav-btn" id="prevImageBtn" onclick="navigateImage(-1)">‚Üê Previous</button>
                            <div class="image-counter" id="imageCounter"></div>
                            <button class="image-nav-btn" id="nextImageBtn" onclick="navigateImage(1)">Next ‚Üí</button>
                        </div>
                        <div class="results-image-wrapper" id="resultsImageWrapper">
                            <img id="resultsImage" class="results-image" alt="Analysis results">
                        </div>
                    </div>

                    <!-- Right Side: Detections List -->
                    <div class="detections-list-section">
                        <h2 class="detections-header">All Detections</h2>
                        
                        <!-- Confidence Filter -->
                        <div class="confidence-filter-section">
                            <div class="confidence-filter-label">
                                <span>Minimum Confidence</span>
                                <span class="confidence-filter-value" id="confidenceFilterValue">0%</span>
                            </div>
                            <input type="range" min="0" max="100" value="0" class="confidence-slider" id="confidenceSlider">
                            <div class="detection-count" id="detectionCount">Showing all detections</div>
                        </div>
                        
                        <div id="detectionsContainer"></div>
                        <button class="inspect-another-btn" id="inspectAnotherBtn" style="display: none;">Inspect Another Area</button>
                        <button class="inspect-another-btn" id="inspectNextAreaBtn" style="display: none; margin-top: 15px;">Inspect Next Area</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const API_BASE_URL = window.location.origin;
        const API_ANALYZE_ENDPOINT = `${API_BASE_URL}/api/analyze`;

        // ========================================
        // GLOBAL STATE
        // ========================================
        let selectedArea = "";
        let selectedImages = []; // Array of {file, dataURL, index}
        let selectedImageFiles = [];
        let currentPredictions = [];
        let allImageResults = []; // Store results for all images
        let currentImageIndex = 0; // Track which image is currently displayed
        let imageNaturalWidth = 0;
        let imageNaturalHeight = 0;
        let minConfidence = 0; // Minimum confidence threshold (0-100)
        let falsePositives = new Set(); // Track false positive predictions by unique ID

        // ========================================
        // PAGE NAVIGATION
        // ========================================
        function showPage(pageNumber) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page${pageNumber}`).classList.add('active');
            updateSidebarActiveState();
        }

        // ========================================
        // SIDEBAR NAVIGATION
        // ========================================
        const sidebarHomeBtn = document.getElementById('sidebarHomeBtn');
        
        sidebarHomeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            handleHomeNavigation();
        });

        // Update active state of sidebar items
        function updateSidebarActiveState() {
            const currentPage = document.querySelector('.page.active');
            if (currentPage) {
                const pageId = currentPage.id;
                // Remove active class from all items
                document.querySelectorAll('.sidebar-nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active to Home if on homepage
                if (pageId === 'page0') {
                    sidebarHomeBtn.classList.add('active');
                }
            }
        }

        // Initialize sidebar active state on page load
        updateSidebarActiveState();

        // ========================================
        // PAGE 0: HOMEPAGE
        // ========================================
        document.getElementById('newInspectionBtn').addEventListener('click', () => {
            showPage(1);
            updateSidebarActiveState();
        });

        // ========================================
        // PAGE 1: AREA SELECTION
        // ========================================
        const areaButtons = document.querySelectorAll('.area-btn');
        const startInspectionBtn = document.getElementById('startInspectionBtn');
        
        areaButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove selection from all buttons
                areaButtons.forEach(b => b.classList.remove('selected'));
                // Add selection to clicked button
                this.classList.add('selected');
                selectedArea = this.dataset.area;
                // Enable Start Inspection button when area is selected
                startInspectionBtn.disabled = false;
            });
        });

        // Start Inspection button - navigate to Image Input page
        startInspectionBtn.addEventListener('click', () => {
            if (selectedArea) {
                showPage(2);
            }
        });

        // ========================================
        // PAGE 2: IMAGE INPUT
        // ========================================
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const uploadImageBtn = document.getElementById('uploadImageBtn');
        const fileInput = document.getElementById('fileInput');
        const imageThumbnailsGrid = document.getElementById('imageThumbnailsGrid');
        const analyzeBtn = document.getElementById('analyzeBtn');

        takePhotoBtn.addEventListener('click', () => {
            fileInput.setAttribute('capture', 'environment');
            fileInput.removeAttribute('multiple');
            fileInput.click();
        });

        uploadImageBtn.addEventListener('click', () => {
            fileInput.removeAttribute('capture');
            fileInput.setAttribute('multiple', 'multiple');
            fileInput.click();
        });

        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            // Filter valid image files
            const validFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (validFiles.length === 0) {
                alert('Please select valid image files.');
                return;
            }

            // Process each file
            validFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const dataURL = event.target.result;
                    const imageData = {
                        file: file,
                        dataURL: dataURL,
                        index: selectedImages.length
                    };
                    
                    selectedImages.push(imageData);
                    selectedImageFiles.push(file);
                    
                    addImageThumbnail(imageData);
                    updateAnalyzeButton();
                };
                reader.readAsDataURL(file);
            });
            
            // Reset file input after processing
            e.target.value = '';
        });

        function addImageThumbnail(imageData) {
            const wrapper = document.createElement('div');
            wrapper.className = 'image-thumbnail-wrapper';
            wrapper.dataset.index = imageData.index;
            
            const img = document.createElement('img');
            img.src = imageData.dataURL;
            img.className = 'image-thumbnail';
            img.alt = imageData.file.name;
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'image-thumbnail-name';
            nameDiv.textContent = imageData.file.name.length > 20 
                ? imageData.file.name.substring(0, 20) + '...' 
                : imageData.file.name;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'thumbnail-remove';
            removeBtn.innerHTML = '√ó';
            removeBtn.onclick = () => removeImage(imageData.index);
            
            wrapper.appendChild(img);
            wrapper.appendChild(nameDiv);
            wrapper.appendChild(removeBtn);
            
            imageThumbnailsGrid.appendChild(wrapper);
        }

        function removeImage(index) {
            // Remove from arrays
            selectedImages = selectedImages.filter((img, i) => {
                if (i === index) return false;
                if (i > index) img.index--; // Update indices
                return true;
            });
            selectedImageFiles = selectedImageFiles.filter((_, i) => i !== index);
            
            // Remove from DOM
            const wrapper = document.querySelector(`[data-index="${index}"]`);
            if (wrapper) wrapper.remove();
            
            // Update remaining indices
            document.querySelectorAll('.image-thumbnail-wrapper').forEach(w => {
                const idx = parseInt(w.dataset.index);
                if (idx > index) w.dataset.index = idx - 1;
            });
            
            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            analyzeBtn.disabled = !(selectedArea && selectedImageFiles.length > 0);
        }

        // ========================================
        // PAGE 1: ANALYZE BUTTON
        // ========================================
        analyzeBtn.addEventListener('click', async () => {
            if (!selectedImageFiles || selectedImageFiles.length === 0 || !selectedArea) {
                alert('Please select an area and upload at least one image.');
                return;
            }

            // Show page 3 with loading
            showPage(3);
            document.getElementById('loadingSpinner').classList.add('show');
            document.getElementById('resultsContent').style.display = 'none';

            try {
                const result = await callBackendAPI(selectedImageFiles, selectedArea);
                allImageResults = result.results || [];
                currentPredictions = result.predictions || [];
                currentImageIndex = 0;
                
                // Display results with first image
                if (allImageResults.length > 0 && selectedImages.length > 0) {
                    displayResults(selectedImages, allImageResults, currentPredictions, selectedArea);
                }
            } catch (error) {
                console.error('Error analyzing images:', error);
                let errorMessage = 'Failed to analyze images.';
                
                if (error.response) {
                    errorMessage = error.response.message || error.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(`Error: ${errorMessage}\n\nPlease check:\n- Server is running\n- API keys are configured in .env file`);
                
                // Go back to page 2
                showPage(2);
            } finally {
                document.getElementById('loadingSpinner').classList.remove('show');
            }
        });

        // ========================================
        // API CALL
        // ========================================
        async function callBackendAPI(imageFiles, area) {
            const formData = new FormData();
            
            // Append all image files
            imageFiles.forEach(file => {
                formData.append('image', file);
            });
            
            formData.append('area', area);

            const response = await fetch(API_ANALYZE_ENDPOINT, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw {
                    response: errorData,
                    message: errorData.message || `Server error: ${response.status} ${response.statusText}`
                };
            }

            return await response.json();
        }

        // ========================================
        // PAGE 3: DISPLAY RESULTS
        // ========================================
        function displayResults(images, imageResults, allPredictions, area) {
            const resultsImage = document.getElementById('resultsImage');
            const resultsImageWrapper = document.getElementById('resultsImageWrapper');
            const detectionsContainer = document.getElementById('detectionsContainer');
            
            // Clear previous content
            detectionsContainer.innerHTML = '';
            const existingBoxes = resultsImageWrapper.querySelectorAll('.defect-box');
            existingBoxes.forEach(box => box.remove());
            
            // Show first image by default
            if (images.length > 0 && imageResults.length > 0) {
                showImageResults(0, images, imageResults, allPredictions, area);
            }
        }

        function navigateImage(direction) {
            if (allImageResults.length === 0 || selectedImages.length === 0) return;
            
            const newIndex = currentImageIndex + direction;
            if (newIndex >= 0 && newIndex < selectedImages.length) {
                showImageResults(newIndex, selectedImages, allImageResults, currentPredictions, selectedArea);
            }
        }

        function showImageResults(imageIndex, images, imageResults, allPredictions, area) {
            const resultsImage = document.getElementById('resultsImage');
            const resultsImageWrapper = document.getElementById('resultsImageWrapper');
            const detectionsContainer = document.getElementById('detectionsContainer');
            
            currentImageIndex = imageIndex;
            const imageData = images[imageIndex];
            const imageResult = imageResults[imageIndex];
            
            if (!imageData || !imageResult) return;
            
            // Clear previous boxes
            const existingBoxes = resultsImageWrapper.querySelectorAll('.defect-box');
            existingBoxes.forEach(box => box.remove());
            
            // Show image
            resultsImage.src = imageData.dataURL;
            
            // Get predictions for this image
            const imagePredictions = allPredictions.filter(p => p.imageIndex === imageIndex);
            
            // Wait for image to load before drawing boxes
            resultsImage.onload = function() {
                imageNaturalWidth = this.naturalWidth;
                imageNaturalHeight = this.naturalHeight;
                
                const imgRect = this.getBoundingClientRect();
                const scaleX = imgRect.width / imageNaturalWidth;
                const scaleY = imgRect.height / imageNaturalHeight;

                // Create defect boxes and extract thumbnails
                imagePredictions.forEach((prediction, index) => {
                    // Roboflow API returns coordinates in different formats
                    // Common formats:
                    // 1. x, y as center coordinates with width, height
                    // 2. x_center, y_center as center coordinates with width, height
                    // 3. x, y as top-left with width, height
                    // We need to handle all cases and convert to top-left coordinates
                    
                    let x, y, width, height;
                    
                    // Get width and height first (usually consistent)
                    width = prediction.width || 0;
                    height = prediction.height || 0;
                    
                    // Handle different coordinate formats
                    if (prediction.x_center !== undefined && prediction.y_center !== undefined) {
                        // Center-based coordinates: convert to top-left
                        x = prediction.x_center - width / 2;
                        y = prediction.y_center - height / 2;
                    } else if (prediction.x !== undefined && prediction.y !== undefined) {
                        // Check if x, y are center coordinates (typical Roboflow format)
                        // Roboflow typically returns x, y as center coordinates
                        // If width and height exist, assume center-based
                        if (width > 0 && height > 0) {
                            // Assume center coordinates (Roboflow standard)
                            x = prediction.x - width / 2;
                            y = prediction.y - height / 2;
                        } else {
                            // Fallback: assume top-left if no dimensions
                            x = prediction.x;
                            y = prediction.y;
                        }
                    } else {
                        // Try bbox format
                        const bbox = prediction.bbox || {};
                        if (bbox.x_center !== undefined && bbox.y_center !== undefined) {
                            x = bbox.x_center - (bbox.width || width) / 2;
                            y = bbox.y_center - (bbox.height || height) / 2;
                            width = bbox.width || width;
                            height = bbox.height || height;
                        } else {
                            x = bbox.x || 0;
                            y = bbox.y || 0;
                            width = bbox.width || width;
                            height = bbox.height || height;
                        }
                    }

                    // Get confidence value
                    const confidence = prediction.confidence 
                        ? Math.round(prediction.confidence * 100) 
                        : (prediction.confidence_percent || 0);
                    
                    // Get prediction ID
                    const predictionId = getPredictionId(prediction, imageIndex);
                    const isFalsePositive = falsePositives.has(predictionId);
                    
                    // Create box
                    const box = document.createElement('div');
                    box.className = 'defect-box';
                    box.dataset.predictionIndex = index;
                    box.dataset.predictionId = predictionId;
                    box.dataset.confidence = confidence;
                    
                    // Apply false positive styling if needed
                    if (isFalsePositive) {
                        box.classList.add('false-positive');
                    }
                    
                    // Hide if below confidence threshold or false positive
                    if (confidence < minConfidence || isFalsePositive) {
                        box.classList.add('hidden');
                    }
                    
                    const scaledX = x * scaleX;
                    const scaledY = y * scaleY;
                    const scaledWidth = width * scaleX;
                    const scaledHeight = height * scaleY;

                    box.style.left = `${scaledX}px`;
                    box.style.top = `${scaledY}px`;
                    box.style.width = `${scaledWidth}px`;
                    box.style.height = `${scaledHeight}px`;

                    // Add label
                    if (prediction.class) {
                        const label = document.createElement('div');
                        label.className = 'defect-label';
                        label.textContent = `${prediction.class} (${confidence}%)`;
                        box.appendChild(label);
                    }

                    resultsImageWrapper.appendChild(box);
                });
                
                // Update filter display after boxes are created
                updateFilterDisplay();
            };
            
            // Display detections list with thumbnails
            detectionsContainer.innerHTML = '';
            
            if (imagePredictions.length === 0) {
                detectionsContainer.innerHTML = `
                    <div class="no-detections">
                        <div class="no-detections-text">No Defects Detected</div>
                        <div style="margin-top: 15px; color: #666; font-size: 0.9rem;">Area: ${formatAreaName(area)}</div>
                        <div style="margin-top: 10px; color: #666; font-size: 0.85rem;">Image: ${imageData.file.name}</div>
                    </div>
                `;
                document.getElementById('detectionCount').textContent = 'Showing 0 of 0 detections';
            } else {
                // Create thumbnails for each defect
                imagePredictions.forEach((prediction, index) => {
                    createDefectThumbnail(prediction, imageData, index, imagePredictions.length, imageIndex);
                });

                // Add summary info
                const summary = document.createElement('div');
                summary.className = 'detection-item summary-item';
                summary.style.borderTop = '2px solid #000000';
                summary.style.marginTop = '15px';
                summary.style.paddingTop = '15px';
                summary.innerHTML = `
                    <div style="color: #666; font-weight: 500; font-size: 0.85rem;">Area Inspected: ${formatAreaName(area)}</div>
                    <div style="color: #666; font-size: 0.75rem; margin-top: 3px;">Image: ${imageData.file.name}</div>
                    <div style="color: #666; font-size: 0.75rem; margin-top: 3px;">Defects in this image: ${imagePredictions.length}</div>
                    <div style="color: #666; font-size: 0.75rem; margin-top: 3px;">Total images: ${images.length}</div>
                    <div style="color: #666; font-size: 0.75rem; margin-top: 3px;">Total defects (all images): ${allPredictions.length}</div>
                `;
                detectionsContainer.appendChild(summary);
                
                // Update filter and false positive states
                updateFilterDisplay();
            }

            // Show/hide navigation based on number of images
            const imageNavigation = document.getElementById('imageNavigation');
            if (images.length > 1) {
                imageNavigation.style.display = 'flex';
                document.getElementById('prevImageBtn').disabled = imageIndex === 0;
                document.getElementById('nextImageBtn').disabled = imageIndex === images.length - 1;
                document.getElementById('imageCounter').textContent = `Image ${imageIndex + 1} of ${images.length}`;
            } else {
                imageNavigation.style.display = 'none';
            }

            // Show "Inspect Next Area" button if on last image
            const inspectNextAreaBtn = document.getElementById('inspectNextAreaBtn');
            const inspectAnotherBtn = document.getElementById('inspectAnotherBtn');
            if (imageIndex === images.length - 1) {
                inspectNextAreaBtn.style.display = 'block';
                inspectAnotherBtn.style.display = 'none';
            } else {
                inspectNextAreaBtn.style.display = 'none';
                inspectAnotherBtn.style.display = 'block';
            }

            // Show results content
            document.getElementById('resultsContent').style.display = 'block';
        }

        function createDefectThumbnail(prediction, imageData, index, totalDefects, imageIndex) {
            const detectionsContainer = document.getElementById('detectionsContainer');
            
            // Extract defect coordinates (same logic as main image boxes)
            let x, y, width, height;
            
            // Get width and height first
            width = prediction.width || 0;
            height = prediction.height || 0;
            
            // Handle different coordinate formats
            if (prediction.x_center !== undefined && prediction.y_center !== undefined) {
                x = prediction.x_center - width / 2;
                y = prediction.y_center - height / 2;
            } else if (prediction.x !== undefined && prediction.y !== undefined) {
                if (width > 0 && height > 0) {
                    // Assume center coordinates (Roboflow standard)
                    x = prediction.x - width / 2;
                    y = prediction.y - height / 2;
                } else {
                    x = prediction.x;
                    y = prediction.y;
                }
            } else {
                const bbox = prediction.bbox || {};
                if (bbox.x_center !== undefined && bbox.y_center !== undefined) {
                    x = bbox.x_center - (bbox.width || width) / 2;
                    y = bbox.y_center - (bbox.height || height) / 2;
                    width = bbox.width || width;
                    height = bbox.height || height;
                } else {
                    x = bbox.x || 0;
                    y = bbox.y || 0;
                    width = bbox.width || width;
                    height = bbox.height || height;
                }
            }

            // Create unique prediction ID
            const predictionId = getPredictionId(prediction, imageIndex);
            
            // Check if this is already marked as false positive
            const isFalsePositive = falsePositives.has(predictionId);

            // Create canvas to crop defect
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Ensure coordinates are within image bounds
                const cropX = Math.max(0, Math.min(x, img.width));
                const cropY = Math.max(0, Math.min(y, img.height));
                const cropWidth = Math.max(1, Math.min(width, img.width - cropX));
                const cropHeight = Math.max(1, Math.min(height, img.height - cropY));
                
                canvas.width = cropWidth;
                canvas.height = cropHeight;
                ctx.drawImage(img, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                
                const thumbnailDataURL = canvas.toDataURL('image/jpeg', 0.9);
                
                // Create detection item
                const detectionItem = document.createElement('div');
                detectionItem.className = 'detection-item' + (isFalsePositive ? ' false-positive' : '');
                detectionItem.dataset.predictionIndex = index;
                detectionItem.dataset.predictionId = predictionId;
                detectionItem.onclick = (e) => {
                    // Don't highlight if clicking on checkbox
                    if (!e.target.classList.contains('false-positive-checkbox')) {
                        highlightDefect(index);
                    }
                };
                
                const confidence = prediction.confidence 
                    ? Math.round(prediction.confidence * 100) 
                    : (prediction.confidence_percent || 0);
                
                let coordsText = '';
                if (prediction.x_center !== undefined && prediction.y_center !== undefined) {
                    coordsText = `Center: (${Math.round(prediction.x_center)}, ${Math.round(prediction.y_center)})`;
                } else if (prediction.x !== undefined && prediction.y !== undefined) {
                    coordsText = `Position: (${Math.round(prediction.x)}, ${Math.round(prediction.y)})`;
                }
                
                // Create X button in top-right corner
                const xButton = document.createElement('button');
                xButton.className = 'false-positive-x-button';
                xButton.innerHTML = '√ó';
                xButton.title = isFalsePositive ? 'Restore detection' : 'Mark as False Positive';
                xButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFalsePositive(predictionId, imageIndex, index);
                });
                
                // Create detection header
                const header = document.createElement('div');
                header.className = 'detection-header';
                
                const thumbnailImg = document.createElement('img');
                thumbnailImg.src = thumbnailDataURL;
                thumbnailImg.alt = 'Defect thumbnail';
                thumbnailImg.className = 'defect-thumbnail';
                thumbnailImg.addEventListener('click', (e) => {
                    e.stopPropagation();
                    highlightDefect(index);
                });
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'detection-info';
                infoDiv.innerHTML = `
                    <div class="detection-type">${prediction.class || 'Defect ' + (index + 1)}</div>
                    <div class="detection-confidence">Confidence: ${confidence}%</div>
                    <div class="detection-image-source">From: ${imageData.file.name}</div>
                    ${coordsText ? `<div class="detection-coords">${coordsText}</div>` : ''}
                `;
                
                header.appendChild(thumbnailImg);
                header.appendChild(infoDiv);
                
                detectionItem.appendChild(header);
                detectionItem.appendChild(xButton);
                
                detectionsContainer.appendChild(detectionItem);
            };
            img.src = imageData.dataURL;
        }

        function highlightDefect(predictionIndex) {
            // Remove previous highlights
            document.querySelectorAll('.defect-box.highlighted').forEach(box => {
                box.classList.remove('highlighted');
            });
            document.querySelectorAll('.detection-item.highlighted').forEach(item => {
                item.classList.remove('highlighted');
            });
            
            // Highlight the box
            const box = document.querySelector(`.defect-box[data-prediction-index="${predictionIndex}"]`);
            if (box) {
                box.classList.add('highlighted');
                // Scroll the image into view if needed
                const resultsImage = document.getElementById('resultsImage');
                resultsImage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Also try to scroll the box into view within the image container
                setTimeout(() => {
                    const wrapper = document.getElementById('resultsImageWrapper');
                    const wrapperRect = wrapper.getBoundingClientRect();
                    const boxRect = box.getBoundingClientRect();
                    if (boxRect.top < wrapperRect.top || boxRect.bottom > wrapperRect.bottom) {
                        box.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                    }
                }, 100);
            }
            
            // Highlight the detection item
            const item = document.querySelector(`.detection-item[data-prediction-index="${predictionIndex}"]`);
            if (item) {
                item.classList.add('highlighted');
                setTimeout(() => {
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 200);
            }
        }

        function formatAreaName(area) {
            return area.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // ========================================
        // CONFIDENCE FILTER
        // ========================================
        document.getElementById('confidenceSlider').addEventListener('input', function(e) {
            minConfidence = parseInt(e.target.value);
            document.getElementById('confidenceFilterValue').textContent = minConfidence + '%';
            updateFilterDisplay();
        });

        function filterDetections() {
            const allItems = document.querySelectorAll('.detection-item:not(.summary-item)');
            let visibleInListCount = 0;
            let visibleOnImageCount = 0;
            
            // Get predictions for current image
            const imagePredictions = currentPredictions.filter(p => p.imageIndex === currentImageIndex);
            const totalCount = imagePredictions.length;
            
            // Filter detection items in the list
            allItems.forEach(item => {
                const predictionId = item.dataset.predictionId;
                const isFalsePositive = predictionId && falsePositives.has(predictionId);
                const confidenceText = item.querySelector('.detection-confidence')?.textContent;
                
                let confidence = 0;
                if (confidenceText) {
                    const confidenceMatch = confidenceText.match(/(\d+)%/);
                    if (confidenceMatch) {
                        confidence = parseInt(confidenceMatch[1]);
                    }
                }
                
                // Show in list if meets confidence threshold (regardless of false positive status)
                if (confidence >= minConfidence) {
                    item.style.display = '';
                    visibleInListCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Filter bounding boxes on the main image
            document.querySelectorAll('.defect-box').forEach(box => {
                const confidence = parseInt(box.dataset.confidence || '0');
                const predictionId = box.dataset.predictionId;
                const isFalsePositive = predictionId && falsePositives.has(predictionId);
                
                // Hide if below confidence threshold OR marked as false positive
                if (confidence < minConfidence || isFalsePositive) {
                    box.classList.add('hidden');
                } else {
                    box.classList.remove('hidden');
                    visibleOnImageCount++;
                }
            });
            
            // Update count display to reflect what's visible on the image
            const countElement = document.getElementById('detectionCount');
            if (countElement) {
                countElement.textContent = `Showing ${visibleOnImageCount} of ${totalCount} detections on image`;
            }
        }

        function updateFilterDisplay() {
            updateFalsePositiveStates(); // Update false positive states first
            filterDetections(); // Then update filter counts
        }

        // ========================================
        // FALSE POSITIVE TRACKING
        // ========================================
        function getPredictionId(prediction, imageIndex) {
            // Create a unique ID for each prediction based on its properties
            return `${imageIndex}_${prediction.x_center || prediction.x || 0}_${prediction.y_center || prediction.y || 0}_${prediction.class || 'unknown'}`;
        }

        function toggleFalsePositive(predictionId, imageIndex, predictionIndex) {
            if (falsePositives.has(predictionId)) {
                falsePositives.delete(predictionId);
            } else {
                falsePositives.add(predictionId);
            }
            
            // Update UI (this will also update filters)
            updateFalsePositiveStates();
        }

        function updateFalsePositiveStates() {
            // Update detection items
            document.querySelectorAll('.detection-item').forEach(item => {
                const predictionId = item.dataset.predictionId;
                const xButton = item.querySelector('.false-positive-x-button');
                const isFalsePositive = predictionId && falsePositives.has(predictionId);
                
                if (isFalsePositive) {
                    item.classList.add('false-positive');
                    if (xButton) {
                        xButton.title = 'Restore detection';
                    }
                } else {
                    item.classList.remove('false-positive');
                    if (xButton) {
                        xButton.title = 'Mark as False Positive';
                    }
                }
            });
            
            // Update defect boxes using predictionId stored in dataset
            document.querySelectorAll('.defect-box').forEach(box => {
                const predictionId = box.dataset.predictionId;
                const confidence = parseInt(box.dataset.confidence || '0');
                const isFalsePositive = predictionId && falsePositives.has(predictionId);
                
                if (isFalsePositive) {
                    box.classList.add('false-positive');
                    // Hide if false positive
                    box.classList.add('hidden');
                } else {
                    box.classList.remove('false-positive');
                    // Show/hide based on confidence threshold
                    if (confidence < minConfidence) {
                        box.classList.add('hidden');
                    } else {
                        box.classList.remove('hidden');
                    }
                }
            });
        }

        // ========================================
        // PAGE 3: INSPECT ANOTHER AREA BUTTON
        // ========================================
        document.getElementById('inspectAnotherBtn').addEventListener('click', () => {
            resetToNewInspection();
        });

        // ========================================
        // PAGE 3: INSPECT NEXT AREA BUTTON
        // ========================================
        document.getElementById('inspectNextAreaBtn').addEventListener('click', () => {
            resetToNewInspection();
        });

        // ========================================
        // PAGE 3: HOME BUTTON
        // ========================================
        document.getElementById('homeBtn').addEventListener('click', () => {
            handleHomeNavigation();
        });

        function resetToNewInspection() {
            // Reset state
            selectedArea = "";
            selectedImages = [];
            selectedImageFiles = [];
            currentPredictions = [];
            allImageResults = [];
            currentImageIndex = 0;
            minConfidence = 0;
            falsePositives.clear();
            
            // Reset UI
            areaButtons.forEach(btn => btn.classList.remove('selected'));
            document.getElementById('imageThumbnailsGrid').innerHTML = '';
            fileInput.value = "";
            analyzeBtn.disabled = true;
            
            // Go back to page 1 (area selection)
            showPage(1);
            // Reset Start Inspection button
            startInspectionBtn.disabled = true;
        }

        function handleHomeNavigation() {
            // Check if there are results to save (only if on results page)
            const currentPage = document.querySelector('.page.active');
            if (currentPage && currentPage.id === 'page3' && allImageResults.length > 0 && currentPredictions.length > 0) {
                const shouldSave = confirm('Save inspection results before going home?');
                if (shouldSave) {
                    saveInspectionResults();
                }
            }
            
            // Reset everything and go home
            selectedArea = "";
            selectedImages = [];
            selectedImageFiles = [];
            currentPredictions = [];
            allImageResults = [];
            currentImageIndex = 0;
            minConfidence = 0;
            falsePositives.clear();
            
            // Reset UI
            areaButtons.forEach(btn => btn.classList.remove('selected'));
            document.getElementById('imageThumbnailsGrid').innerHTML = '';
            fileInput.value = "";
            analyzeBtn.disabled = true;
            if (document.getElementById('confidenceSlider')) {
                document.getElementById('confidenceSlider').value = 0;
                document.getElementById('confidenceFilterValue').textContent = '0%';
            }
            
            // Reset Start Inspection button
            if (startInspectionBtn) {
                startInspectionBtn.disabled = true;
            }
            
            // Go to homepage
            showPage(0);
            updateSidebarActiveState();
        }

        function saveInspectionResults() {
            try {
                // Collect valid detections (excluding false positives)
                const validDetections = currentPredictions.filter(prediction => {
                    const predictionId = getPredictionId(prediction, prediction.imageIndex || 0);
                    return !falsePositives.has(predictionId);
                });

                // Group detections by image
                const imageDataMap = new Map();
                allImageResults.forEach((result, idx) => {
                    const imagePredictions = validDetections.filter(p => p.imageIndex === idx);
                    if (imagePredictions.length > 0 || result.predictions) {
                        imageDataMap.set(idx, {
                            imageIndex: idx,
                            imageName: result.imageName,
                            predictions: imagePredictions.map(p => ({
                                class: p.class,
                                confidence: p.confidence,
                                confidence_percent: p.confidence ? Math.round(p.confidence * 100) : (p.confidence_percent || 0),
                                x: p.x || p.x_center,
                                y: p.y || p.y_center,
                                x_center: p.x_center || p.x,
                                y_center: p.y_center || p.y,
                                width: p.width,
                                height: p.height
                            })),
                            image_width: result.image_width,
                            image_height: result.image_height
                        });
                    }
                });

                // Create inspection report
                const inspectionReport = {
                    timestamp: new Date().toISOString(),
                    area: selectedArea,
                    area_display: formatAreaName(selectedArea),
                    total_images: allImageResults.length,
                    total_valid_detections: validDetections.length,
                    total_defects_detected: validDetections.length,
                    images: Array.from(imageDataMap.values()),
                    summary: {
                        total_images_analyzed: allImageResults.length,
                        total_detections_found: currentPredictions.length,
                        false_positives_dismissed: falsePositives.size,
                        valid_detections: validDetections.length,
                        minimum_confidence_used: minConfidence
                    }
                };

                // Create and download JSON file
                const jsonString = JSON.stringify(inspectionReport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `inspection_${selectedArea}_${timestamp}.json`;
                
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('Inspection results saved:', filename);
            } catch (error) {
                console.error('Error saving inspection results:', error);
                alert('Failed to save inspection results. Please try again.');
            }
        }
    </script>
    </div> <!-- End main-content-wrapper -->
</body>
</html>
